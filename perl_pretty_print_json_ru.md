# Человекочитаемый JSON с помощью Perl

date_time: 2015-03-20 00:49:40 MSK

Давно хотел найти возможность создавать pretty JSON из Perl структур.
Задачка-то совершенно тривитальная, на CPAN есть куча модулей как
сериализовать JSON, но мне хотелось чтобы соблюдалось два условия:

 * чтобы отступ был в 4 пробела
 * чтобы имена ключей были отсортированы

## Отступ в 4 пробела

В моем текстом редакторе настроено что по нажатии на <tab> создается отсутп
в 4 пробела. Это достаточно стандартная настройка, очень много кода написано
именно с соблюдением этого стандарта.

Но почему-то многие Perl библиотеки для работы с JSON используют в качестве
отступа по умолчанию 3 пробела. Из-за этого возникает проблемы — из
Perl я создаю JSON c тремя пробелами, комичу этот файл в проект, а потом
когда руками хочу что-то поправить, выясняется что тот формат как я хочу
писать не соответствует формату в файле.

## Сортировка ключей в объекте

Для Perl хеша или объекта JavaScript порядок ключей не определен. Пэтому
сериализатор вполне может использовать любой порядок ключей и это будет
валидно. Но такой вариант очень неудобен — создали JSON с одним порядодком
ключей, закомитили в проект. Потом решили перегенрить JSON и повторно его
создали — и, бац, все ключи в другом порядке "git diff" показывает кучу
изменений, из которых сложно понять что реально изменилось.

Поэтому хочется чтобы JSON всегда формировался одинаково, а для этого
нужно определить какое-то правило в каком порядке должны располагаться ключи.
Самое простое правило — это чтобы ключи были отсортированы

## Решение

Оказалось что решение этой задачи весьма простое. Нужно взять
[JSON::PP](https://metacpan.org/pod/JSON::PP) и использовать его вот таким
образом:

    my $coder = JSON::PP
        ->new
        ->pretty
        ->canonical
        ->indent_length(4)
        ;

    say $coder->encode( $bar );

Вот [полный текст скрипта-примера](https://gist.github.com/bessarabov/c18a7aa18c39d27cfde4).

[JSON::PP](https://metacpan.org/pod/JSON::PP) входит в дефолтную поставку
Perl, начиная с версии 5.14, так что такое решине будет работать из коробки
на всех современных операционных системах.
